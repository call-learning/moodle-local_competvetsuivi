image: moodlehq/moodle-php-apache:7.1

services:
  - mysql:5.7

cache:
  paths:
    - $HOME/.composer/cache

variables:
  DB: "mysqli"
  MYSQL_ROOT_PASSWORD: "superrootpass"
  TRAVIS_BUILD_DIR: "$CI_PROJECT_DIR"

before_script:
  - sed /etc/apt/sources.list -e's/ main/ contrib non-free/g' > /etc/apt/sources.list.d/contribnonfree.list
# Fix issue with openjdk-jre-install
  - mkdir -p /usr/share/man/man1
# Now install all dependencies
  - apt update
  - apt install git-core mariadb-client openjdk-11-jre-headless chromium-driver  -y
  - curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.2/install.sh | bash
  - source ~/.profile
  - nvm install v8.9.0
  - cd $CI_PROJECT_DIR/..
  - curl -sS https://getcomposer.org/installer | php
  - mv composer.phar /usr/local/bin/composer
  - composer create-project -n --no-dev --prefer-dist blackboard-open-source/moodle-plugin-ci ci ^2
  - export PATH="$(cd ci/bin; pwd):$(cd ci/vendor/bin; pwd):$PATH"
  - chmod u+x ci/bin/moodle-plugin-ci
  - chmod u+x ci/bin/*
  - umask u+x
  - moodle-plugin-ci install --db-user=root --db-pass=superrootpass --db-host=mysql

.job_template: &job_definition
  script:
    - EXIT_STATUS=0
    - moodle-plugin-ci phplint
    - moodle-plugin-ci phpcpd
    - moodle-plugin-ci phpmd
    - moodle-plugin-ci codechecker
    - moodle-plugin-ci savepoints
    - moodle-plugin-ci mustache
    - moodle-plugin-ci grunt
    - moodle-plugin-ci validate
    - moodle-plugin-ci phpunit
    - moodle-plugin-ci behat
    - exit $EXIT_STATUS

job_m35:
  <<: *job_definition
  variables:
    MOODLE_BRANCH: "MOODLE_35_STABLE"

job_m36:
  <<: *job_definition
  variables:
    MOODLE_BRANCH: "MOODLE_36_STABLE"

job_master:
  <<: *job_definition
  variables:
    MOODLE_BRANCH: "master"