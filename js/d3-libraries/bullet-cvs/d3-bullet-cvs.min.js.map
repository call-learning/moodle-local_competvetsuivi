{"version":3,"file":"d3-bullet-cvs.min.js","sources":["../src/bullet-cvs.js"],"sourcesContent":["import { axisBottom as d3AxisBottom } from 'd3-axis';\nimport { scaleLinear as d3ScaleLinear, scaleQuantize as d3ScaleQuantize } from 'd3-scale';\nimport { select as d3Select, mouse as d3Mouse } from 'd3-selection';\nimport { timerFlush as d3TimerFlush } from 'd3-timer';\nimport 'd3-transition';\nimport { schemeSet1 as d3SchemeSet1 } from 'd3-scale-chromatic';\n\n/**\n * Make a data structure to hold several bullet charts in one row, so to have a global\n * progress bar\n * @return {bulCVS}\n */\nexport default function () {\n  let maxresults = function (d) {return d.maxresults;};\n  let results = function (d) {return d.results;};\n  let rlabels = function (d) {return d.rlabels;};\n  let data = {};\n  let width = 960;\n  let height = 100;\n  let innerWidth = function () { return width - margins.left - margins.right; };\n  let innerHeight = function () { return height - margins.top - margins.bottom; };\n  let margins = { top: 10, right: 5, bottom: 20, left: 5 };\n  let graphMarginH = 5;\n\n  // For each small multipleâ€¦\n  function bulCVS (svgitem) {\n\n    let graphWidth = innerWidth() / data.length - graphMarginH * 2;\n    let g = svgitem\n      .attr('width', width)\n      .attr('height', height)\n      .selectAll('g') // Map data to an inner g in the svgitem\n      .data(data)\n      .enter()\n      .append('g')\n      .attr('class', 'bullet-cvs');\n\n    g.each(function (d, i) {\n      let cmaxresults = maxresults(d);\n      let cresults = results(d);\n      let crlabels = rlabels(d);\n      let currentg = d3Select(this);\n      let extentX;\n      let extentY;\n\n      let wrap = currentg.select('g.wrap');\n      if (wrap.empty()) wrap = currentg.append('g').attr('class', 'wrap');\n\n      extentX = graphWidth;\n      extentY = innerHeight();\n\n      // Compute the new x-scale.\n      const domainMaxRange = Math.max(Math.max.apply(null, cmaxresults), Math.max.apply(null, cresults));\n      const scaleX = d3ScaleLinear()\n        .domain([0, domainMaxRange])\n        .range([0, extentX]);\n\n      let resultsColorScheme = d3SchemeSet1;\n      let maxResultColorScheme = d3SchemeSet1;\n\n      // Derive width-scales from the x-scales.\n      let mstwidth = bulCVSWidth(scaleX); // End width\n\n      let baseStrokeWidth = 2;\n      let baseArrowSize = 10;\n      let barHeight = function (index, factor) { return (extentY / (index / 4 + 1)) / factor; };\n      let markHeight = function (index) { return extentY; };\n      let middlePosition = function (currentHeight, totalHeight) { return totalHeight / 2 - currentHeight / 2; };\n\n      // Draw the track background for max result markers\n      wrap\n        .selectAll('rect.maxresults')\n        .data(cmaxresults)\n        .enter()\n        .append('rect')\n        .attr('class', 'maxresults')\n        .attr('width', mstwidth)\n        .style('fill', (_d, index) => maxResultColorScheme[index])\n        .style('fill-opacity', '0.3')\n        .attr('height', extentY)\n        .attr('x', 0)\n        .attr('y', 0);\n\n      // Draw the result rects\n      // Build Tootipes\n      let restip = d3Tooltip(function (d, index) {return crlabels[index]; });\n      wrap\n        .selectAll('rect.result')\n        .data(cresults)\n        .enter()\n        .append('rect')\n        .attr('class', 'result')\n        .attr('width', mstwidth)\n        .style('fill', (_d, index) => resultsColorScheme[index])\n        .attr('height', function (_d, index) {return barHeight(index, 2);})\n        .attr('x', 0)\n        .attr('y', function (_d, index) { return middlePosition(barHeight(index, 2), extentY);})\n        .on('mouseover', restip.mouseover)\n        .on('mouseout', restip.mouseout)\n        .on('mouseleave', restip.mouseleave);\n\n      // Update the maxresultmarker marker lines.\n\n      // Draw the markers\n      wrap\n        .selectAll('line.marker')\n        .data(cresults)\n        .enter().append('polygon')\n        .attr('class', 'marker')\n        .style('stroke', (_d, index) => resultsColorScheme[index])\n        .style('stroke-width', (_d, index) => baseStrokeWidth * (index + 1))\n        .attr('points', function (d, index) {\n            const size = baseArrowSize / (index + 1);\n            return pointerMaker(size, baseArrowSize, scaleX(d), innerHeight());\n          }\n        );\n\n      const axis = wrap.append('g').attr('class', 'axis');\n      axis.attr('transform', `translate(0,${extentY})`).call(d3AxisBottom(scaleX));\n\n      // Graph Marker\n\n      wrap\n        .selectAll('line.limits')\n        .data([0, graphWidth])\n        .enter()\n        .append('line')\n        .attr('class', 'limits')\n        .style('stroke', '#000')\n        .style('stroke-width', graphMarginH)\n        .attr('x1', scaleX)\n        .attr('x2', scaleX)\n        .attr('y1', function (_d, index) {return (extentY / 2 - markHeight(index) / 2);})\n        .attr('y2', function (_d, index) {return (extentY / 2 + markHeight(index) / 2);});\n\n      // Add label in the middle\n      wrap\n        .selectAll('text.label')\n        .data([d.groupname])\n        .enter()\n        .append('text')\n        .attr('class', 'label')\n        .attr('y', extentY / 2)\n        .attr('x', extentX / 2)\n        .text((d) => d);\n      // Finally translate the graph so it appear next to the other\n\n      currentg.attr('transform', 'translate(' + (margins.left + graphWidth * i + graphMarginH * i) + ',' + margins.top + ')');\n    });\n    d3TimerFlush();\n  }\n\n  // maxresults (previous, goal)\n  bulCVS.maxresults = function (_) {\n    if (!arguments.length) return maxresults;\n    maxresults = _;\n    return this;\n  };\n\n  // results (actual, forecast)\n  bulCVS.results = function (_) {\n    if (!arguments.length) return results;\n    results = _;\n    return this;\n  };\n\n  bulCVS.width = function (_) {\n    if (!arguments.length) return width;\n    width = +_;\n    return this;\n  };\n\n  bulCVS.height = function (_) {\n    if (!arguments.length) return height;\n    height = +_;\n    return this;\n  };\n\n  bulCVS.margins = function (_) {\n    if (!arguments.length) return margins;\n    margins = _;\n    return this;\n  };\n\n  bulCVS.data = function (_) {\n    if (!arguments.length) return data;\n    data = _;\n    return this;\n  };\n\n  bulCVS.tickFormat = function (_) {\n    if (!arguments.length) return xAxis.tickFormat();\n    xAxis.tickFormat(_);\n    return this;\n  };\n\n  return bulCVS;\n}\n\nfunction bulCVSWidth (x) {\n  const x0 = x(0);\n  return function (d) {\n    return Math.abs(x(d) - x0);\n  };\n}\n\n/**\n * Create a triangle oriented toward the bottom, point toward x,y\n * @param base\n * @param height\n * @param x\n * @param y\n */\nfunction pointerMaker (base, height, x, y) {\n  return `${x - base / 2} ${y - height}, ${x + base / 2} ${y - height}, ${x} ${y}`;\n}\n\nfunction d3Tooltip (displayFunction) {\n\n  let tooltip = {};\n  // create a tooltip\n  let tid = 'd3tooltipdiv' + btoa(Math.random()).substring(0, 12);\n  var Tooltip = d3Select('body')\n    .select('#' + tid)\n    .data([0]) // Force add this\n    .enter()\n    .append('div')\n    .style('position', 'absolute')\n    .style('opacity', 0)\n    .attr('class', 'tooltip')\n    .attr('id', tid)\n    .style('background-color', 'white')\n    .style('border', 'solid')\n    .style('border-width', '2px')\n    .style('border-radius', '5px')\n    .style('padding', '5px');\n\n  // Three function that change the tooltip when user hover / move / leave a cell\n  tooltip.mouseover = function (d, index) {\n    Tooltip\n      .style('stroke', 'black')\n      .style('opacity', 1)\n      .html(displayFunction(d, index))\n      .style('left', (d3Mouse(this)[0]) + 'px')\n      .style('top', (d3Mouse(this)[1]) + 'px');\n  };\n  tooltip.mousemove = function (d, index) {\n    Tooltip\n      .style('left', (d3Mouse(this)[0]) + 'px')\n      .style('top', (d3Mouse(this)[1]) + 'px');\n\n  };\n  tooltip.mouseleave = function (d, index) {\n    Tooltip\n      .style('opacity', 0)\n      .style('stroke', 'none');\n  };\n  return tooltip;\n\n}\n"],"names":["maxresults","d","results","rlabels","data","width","height","innerWidth","margins","left","right","innerHeight","top","bottom","graphMarginH","bulCVS","svgitem","graphWidth","length","attr","selectAll","enter","append","each","i","extentX","extentY","cmaxresults","cresults","crlabels","currentg","d3Select","this","wrap","select","empty","domainMaxRange","Math","max","apply","scaleX","d3ScaleLinear","domain","range","resultsColorScheme","d3SchemeSet1","maxResultColorScheme","mstwidth","x","x0","abs","bulCVSWidth","barHeight","index","factor","markHeight","style","_d","restip","displayFunction","tooltip","tid","btoa","random","substring","Tooltip","mouseover","html","d3Mouse","mousemove","mouseleave","d3Tooltip","currentHeight","on","mouseout","base","y","pointerMaker","call","d3AxisBottom","groupname","text","d3TimerFlush","_","arguments","tickFormat","xAxis"],"mappings":"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"}